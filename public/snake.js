<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Benjamin Filler - Cyberpunk Portfolio</title>

    <!-- Favicon -->
    <link
      rel="icon"
      href="https://cdn.glitch.global/09e9ba26-fd4e-41f2-88c1-651c3d32a01a/Benny.png?v=1746392528967"
      type="image/png"
    />

    <!-- Preconnect to Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    
    <!-- Load critical font first -->
    <link
      href="https://fonts.googleapis.com/css2?family=VT323&display=swap"
      rel="stylesheet"
    />
    
    <!-- Load decorative font second -->
    <link
      href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
      rel="stylesheet"
    />

    <!-- Main Stylesheet -->
    <link rel="stylesheet" href="/style.css" />
    
    <!-- Meta tags for SEO -->
    <meta name="description" content="Benjamin Filler - Media creator, director, and narrative systems designer. Explore my portfolio featuring films, games, and interactive experiences.">
    <meta name="keywords" content="Benjamin Filler, media creator, director, narrative design, cyberpunk, experimental documentary, game worlds">
  </head>
  <body>
    <!-- Scanlines -->
    <div class="scanlines"></div>

    <!-- Boot Screen -->
      <div id="bootScreen" class="boot-screen">
    <pre id="boot-log" class="boot-log"></pre>
    <div class="progress-container">
      <div id="progress-bar" class="progress-bar"></div>
    </div>
  </div>

    <!-- Desktop Container -->
    <div class="container">
      <h1 class="glitch" data-text="Benjamin Filler">Benjamin Filler</h1>
      <div id="desktop-icons">
        <!-- Original Icons -->
        <div class="desktop-icon" id="icon-about" data-window="about">
          <img
            src="https://cdn.glitch.global/09e9ba26-fd4e-41f2-88c1-651c3d32a01a/Benny.png?v=1746392528967"
            alt="About"
            loading="eager"
          />
          <span>About</span>
        </div>
        
        <div class="desktop-icon" id="icon-tigerrr" data-window="TIGERRR">
          <img src="https://cdn.glitch.global/09e9ba26-fd4e-41f2-88c1-651c3d32a01a/whodat.gif?v=1746365769069" alt="TIGERRR" loading="lazy" />
          <span>TIGERRR</span>
        </div>
        
        <div class="desktop-icon" id="icon-octavia" data-window="OCTAVIA">
          <img src="https://cdn.glitch.global/09e9ba26-fd4e-41f2-88c1-651c3d32a01a/octavia.jpg?v=1746412752104" alt="OCTAVIA" loading="lazy" />
          <span>OCTAVIA</span>
        </div>

        <div class="desktop-icon" id="icon-MILES" data-window="MILES">
          <img src="https://cdn.glitch.global/09e9ba26-fd4e-41f2-88c1-651c3d32a01a/MilesSwings2025.jpg?v=1746410914289" alt="MILES" loading="lazy" />
          <span>MILES</span>
        </div>
        
        <div class="desktop-icon" id="icon-resume" data-window="resume">
          <img
            src="https://cdn.glitch.global/09e9ba26-fd4e-41f2-88c1-651c3d32a01a/cv.png?v=1746621876924"
            alt="Resume"
            loading="lazy"
          />
          <span>Resume</span>
        </div>
        
        <div class="desktop-icon" id="icon-toader" data-window="toader">
          <img
            src="https://cdn.glitch.global/09e9ba26-fd4e-41f2-88c1-651c3d32a01a/psychtoadglow.gif?v=1746572262753"
            alt="Toader"
            loading="lazy"
          />
          <span>Psych Toad</span>
        </div>
        
        <div class="desktop-icon" id="icon-contact" data-window="contact">
          <img
            src="https://cdn.glitch.global/09e9ba26-fd4e-41f2-88c1-651c3d32a01a/EmailPic.png?v=1746392934373"
            alt="Contact"
            loading="lazy"
          />
          <span>Contact</span>
        </div>
       
        <div class="desktop-icon" id="icon-nature" data-window="nature">
          <img
            src="https://cdn.glitch.global/09e9ba26-fd4e-41f2-88c1-651c3d32a01a/VaporTree.png?v=1746411815542"
            alt="Nature"
            loading="lazy"
          />
          <span>Nature</span>
        </div>
      
        <div class="desktop-icon" id="icon-Joyful" data-window="Joyful">
          <img
            src="https://cdn.glitch.global/09e9ba26-fd4e-41f2-88c1-651c3d32a01a/VaporTV.png?v=1746411817932"
            alt="Joyful"
            loading="lazy"
          />
          <span>Joyful</span>
        </div>
      
        <div class="desktop-icon" id="icon-Papaz" data-window="Papaz">
          <img
            src="https://cdn.glitch.global/09e9ba26-fd4e-41f2-88c1-651c3d32a01a/VaporTV.png?v=1746411817932"
            alt="Papaz"
            loading="lazy"
          />
          <span>Papaz</span>
        </div>
      
        <div class="desktop-icon" id="icon-Abstract" data-window="Abstract">
          <img
            src="https://cdn.glitch.global/09e9ba26-fd4e-41f2-88c1-651c3d32a01a/VaporTV.png?v=1746411817932"
            alt="Abstract"
            loading="lazy"
          />
          <span>Abstract</span>
        </div>
      
        <div class="desktop-icon" id="icon-music" data-window="music">
          <img
            src="https://cdn.glitch.global/09e9ba26-fd4e-41f2-88c1-651c3d32a01a/CDROM.gif?v=1746411773467"
            alt="Music"
            loading="lazy"
          />
          <span>Music</span>
        </div>
        
        <div class="desktop-icon" id="icon-SPACEWORM" data-window="SPACEWORM">
          <img
            src="https://cdn.glitch.global/09e9ba26-fd4e-41f2-88c1-651c3d32a01a/TrippyWorm.png?v=1746410810962"
            alt="SPACEWORM"
            loading="lazy"
          />
          <span>Spaceworm</span>
        </div>
      
        <div class="desktop-icon" id="icon-r3d3ch0" data-window="r3d3ch0">
          <img
            src="https://cdn.glitch.global/09e9ba26-fd4e-41f2-88c1-651c3d32a01a/VaporTree.png?v=1746411815542"
            alt="r3d3ch0"
            loading="lazy"
          />
          <span>r3d3ch0</span>
        </div>
        
        <!-- New Game Icons -->
        <div class="desktop-icon" id="icon-tetris" data-window="tetris">
          <img
            src="https://cdn.glitch.global/09e9ba26-fd4e-41f2-88c1-651c3d32a01a/tetris-icon.gif"
            alt="Tetris"
            loading="lazy"
          />
          <span>Tetris</span>
        </div>
        
      <!-- ABOUT.EXE -->
      <div id="about" class="popup-window hidden">
        <div class="window-header">
          <span>ABOUT.EXE</span>
          <button class="minimize">_</button>
          <button class="maximize">▭</button>
          <button class="close">X</button>
        </div>
        <div class="window-content">
          <h2>👾 WHO IS BENJAMIN FILLER?</h2>
          <p>
            I'm a media creator, director, and narrative systems designer from
            Michigan. I tell stories across Art, Film, Games, Music, and Interactive Spaces.
          </p>
          <p>
            My work blends cinematic technique, code-based immersion, and analog
            grit. I like strange archives, gripping installations, modular synths,
            and custom hardware.
          </p>
          <h3>💾 KEYWORDS</h3>
          <ul>
            <li>⛓ Experimental Documentary</li>
            <li>🧠 Narrative Design</li>
            <li>🛸 Cyberpunk</li>
            <li>🎮 Game Worlds &amp; Story Maps</li>
            <li>📼 Lo-fi / New Media Aesthetics</li>
          </ul>
        </div>
      </div>

      <!-- RESUME.EXE -->
      <div id="resume" class="popup-window hidden">
        <div class="window-header">
          <span>RESUME.EXE</span>
          <button class="minimize">_</button>
          <button class="maximize">▭</button>
          <button class="close">X</button>
        </div>
        <div class="window-content">
          <iframe src="/resume.html" allowfullscreen style="width: 100%; height: 100%; border: none;" loading="lazy"></iframe>
        </div>
      </div>

      <!-- CONTACT.EXE -->
      <div id="contact" class="popup-window hidden">
        <div class="window-header">
          <span>CONTACT.EXE</span>
          <button class="minimize">_</button>
          <button class="maximize">▭</button>
          <button class="close">X</button>
        </div>
        <div class="window-content">
          <iframe src="/contact.html" allowfullscreen loading="lazy"></iframe>
        </div>
      </div>

      <!-- NATURE.EXE -->
      <div id="nature" class="popup-window hidden">
        <div class="window-header">
          <span>NATURE.EXE</span>
          <button class="minimize">_</button>
          <button class="maximize">▭</button>
          <button class="close">X</button>
        </div>
        <div class="window-content">
          <iframe src="/nature.html" style="width: 100%; height: 100%; border: none;" allowfullscreen loading="lazy"></iframe>
        </div>
      </div>

      <!-- VIDEO1.EXE -->
      <div id="video1" class="popup-window hidden">
        <div class="window-header">
          <span>JOYFUL.EXE</span>
          <button class="minimize">_</button>
          <button class="maximize">▭</button>
          <button class="close">X</button>
        </div>
        <div class="window-content">
          <video
            id="video1-player"
            data-src="https://cdn.glitch.me/09e9ba26-fd4e-41f2-88c1-651c3d32a01a/A%20Joyful%20and%20Meaningful%20Life.mp4?v=1746453364188"
            controls
            playsinline
            preload="none"
            poster="https://cdn.glitch.global/09e9ba26-fd4e-41f2-88c1-651c3d32a01a/VaporTV.png?v=1746411817932"
          ></video>
        </div>
      </div>

      <!-- VIDEO2.EXE -->
      <div id="video2" class="popup-window hidden">
        <div class="window-header">
          <span>PAPAZ.EXE</span>
          <button class="minimize">_</button>
          <button class="maximize">▭</button>
          <button class="close">X</button>
        </div>
        <div class="window-content">
          <video
            id="video2-player"
            data-src="https://cdn.glitch.me/09e9ba26-fd4e-41f2-88c1-651c3d32a01a/SEPChallengeVideo2.mp4?v=1746454142843"
            controls
            playsinline
            preload="none"
            poster="https://cdn.glitch.global/09e9ba26-fd4e-41f2-88c1-651c3d32a01a/VaporTV.png?v=1746411817932"
          ></video>
        </div>
      </div>

      <!-- VIDEO3.EXE -->
      <div id="video3" class="popup-window hidden">
        <div class="window-header">
          <span>ABSTRACT.EXE</span>
          <button class="minimize">_</button>
          <button class="maximize">▭</button>
          <button class="close">X</button>
        </div>
        <div class="window-content">
          <video
            id="video3-player"
            data-src="https://cdn.glitch.me/09e9ba26-fd4e-41f2-88c1-651c3d32a01a/SEP%20Challenge-Video%206.mov?v=1746456155714"
            controls
            playsinline
            preload="none"
            poster="https://cdn.glitch.global/09e9ba26-fd4e-41f2-88c1-651c3d32a01a/VaporTV.png?v=1746411817932"
          ></video>
        </div>
      </div>

    
      <!-- MUSIC.EXE -->
      <div id="music" class="popup-window hidden">
        <div class="window-header">
          <span>MUSIC.EXE</span>
          <button class="minimize">_</button>
          <button class="maximize">▭</button>
          <button class="close">X</button>
        </div>
        <div class="window-content">
          <audio id="music-player" preload="none"></audio>
          <div id="now-playing">▶ Loading…</div>
          <div class="music-controls">
            <button id="prevTrack">◀ Prev</button>
            <button id="togglePlay">Play/Pause</button>
            <button id="nextTrack">Next ▶</button>
          </div>
          <ul id="playlist"></ul>
        </div>
      </div>

      <!-- SPACEWORM.EXE -->
      <div id="SPACEWORM" class="popup-window hidden game-window">
        <div class="window-header">
          <span>SPACEWORM.EXE</span>
          <button class="minimize">_</button>
          <button class="maximize">▭</button>
          <button class="close">X</button>
        </div>
        <div class="window-content">
          <canvas id="snake-canvas" width="600" height="600"></canvas>
        </div>
      </div>
      
      <!-- r3d3ch0.EXE -->
      <div id="r3d3ch0" class="popup-window hidden">
        <div class="window-header">
          <span>r3d3ch0.EXE</span>
          <button class="minimize">_</button>
          <button class="maximize">▭</button>
          <button class="close">X</button>
        </div>
        <div class="window-content">
          <iframe
            src="https://storymaps.arcgis.com/stories/e55421d5ad4b4a11bf7986926c38dfc5"
            style="width: 100%; height: 100%; border: none; display: block; background: black;"
            loading="lazy"
          ></iframe>
        </div>
      </div>

    
      <!-- TOADER.EXE -->
      <div id="toader" class="popup-window hidden">
        <div class="window-header">
          <span>TOADER.EXE</span>
          <button class="minimize">_</button>
          <button class="maximize">▭</button>
          <button class="close">X</button>
        </div>
        <div class="window-content toader-comingsoon">
          <img
            src="https://cdn.glitch.global/09e9ba26-fd4e-41f2-88c1-651c3d32a01a/psychtoadglow.gif?v=1746572262753"
            alt="Psychedelic Toad"
            style="max-width: 100%; max-height: 300px; display: block; margin: 1rem auto;"
            loading="lazy"
          />
          <h2 class="psychedelic-text">PSYCHEDELIC TOAD</h2>
          <audio id="toader-audio" src="https://cdn.glitch.global/09e9ba26-fd4e-41f2-88c1-651c3d32a01a/hover.mp3?v=1746577634973" preload="none" loop></audio>
        </div>
      </div>

      <!-- TIGERRR.EXE -->
      <div id="TIGERRR" class="popup-window hidden">
        <div class="window-header">
          <span>TIGERRR.EXE</span>
          <button class="minimize">_</button>
          <button class="maximize">▭</button>
          <button class="close">X</button>
        </div>
        <div class="window-content TIGERRR">
          <img
            src="https://cdn.glitch.global/09e9ba26-fd4e-41f2-88c1-651c3d32a01a/whodat.gif?v=1746365769069"
            alt="TIGERRR"
            style="max-width: 100%; max-height: 300px; display: block; margin: 1rem auto;"
            loading="lazy"
          />
          <h2 class="psychedelic-text">TIGERRR</h2>
          <audio id="TIGERRR-audio" src="https://cdn.glitch.global/09e9ba26-fd4e-41f2-88c1-651c3d32a01a/tiger-roar.mp3" preload="none" loop></audio>
        </div>
      </div>
    
      <!-- OCTAVIA.EXE -->
      <div id="OCTAVIA" class="popup-window hidden">
        <div class="window-header">
          <span>OCTAVIA.EXE</span>
          <button class="minimize">_</button>
          <button class="maximize">▭</button>
          <button class="close">X</button>
        </div>
        <div class="window-content OCTAVIA">
          <img
            src="https://cdn.glitch.global/09e9ba26-fd4e-41f2-88c1-651c3d32a01a/octavia.jpg?v=1746412752104"
            alt="OCTAVIA"
            style="max-width: 100%; max-height: 300px; display: block; margin: 1rem auto;"
            loading="lazy"
          />
          <h2 class="psychedelic-text">OCTAVIA</h2>
        </div>
      </div>

      <!-- MILES.EXE -->
      <div id="MILES" class="popup-window hidden">
        <div class="window-header">
          <span>MILES.EXE</span>
          <button class="minimize">_</button>
          <button class="maximize">▭</button>
          <button class="close">X</button>
        </div>
        <div class="window-content MILES">
          <img
            src="https://cdn.glitch.global/09e9ba26-fd4e-41f2-88c1-651c3d32a01a/MilesSwings2025.jpg?v=1746410914289"
            alt="MILES"
            style="max-width: 100%; max-height: 300px; display: block; margin: 1rem auto;"
            loading="lazy"
          />
          <h2 class="psychedelic-text">MILES</h2>
        </div>
      </div>

      <!-- TETRIS.EXE -->
      <div id="tetris" class="popup-window hidden game-window">
        <div class="window-header">
          <span>TETRIS.EXE</span>
          <button class="minimize">_</button>
          <button class="maximize">▭</button>
          <button class="close">X</button>
        </div>
        <div class="window-content">
          <canvas id="tetris-canvas" width="500" height="400"></canvas>
        </div>
      </div>

     </div>
    
      <!-- Starfield Background -->
      <canvas id="background-canvas"></canvas>

      <!-- Audio Visualizer -->
      <canvas id="audio-visualizer"></canvas>

      <!-- Taskbar & Clock -->
      <div id="start-bar">
        <button id="start-button">START</button>
        <div id="taskbar-icons"></div>
        <span id="clock"></span>
      </div>

      <!-- Start Menu -->
      <div id="start-menu">
        <a href="javascript:void(0)" onclick="openWindow('about')">About</a>
        <a href="javascript:void(0)" onclick="openWindow('resume')">Resume</a>
        <a href="javascript:void(0)" onclick="openWindow('contact')">Contact</a>
        <a href="javascript:void(0)" onclick="openWindow('nature')">Nature</a>
        <a href="javascript:void(0)" onclick="openWindow('snake')">SPACEWORM</a>
        <a href="javascript:void(0)" onclick="openWindow('tetris')">TETRIS</a>
       
      </div>
    </div>
    
    <!-- Main Script -->
    <script src="/script.js"></script>
  </body>
</html>

// Utility functions
function debounce(func, wait) {
  let timeout
  return function () {
    const args = arguments
    clearTimeout(timeout)
    timeout = setTimeout(() => func.apply(this, args), wait)
  }
}

// DOM ready handler with performance improvements
function startup() {
  initWindowControls()
  runBootSequence().then(() => {
    initDesktopIcons()
    initStarfield() 
  })
}

  // 2) Lazy-load Snake iframe
  if (id === "snake") {
    const iframe = win.querySelector("iframe[data-src]");
    if (iframe && !iframe.src) iframe.src = iframe.dataset.src;

if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", startup)
} else {
  startup()
}

//────────────────────────────────────────────────────────────────────────────
// 1) WINDOW CONTROLS
//────────────────────────────────────────────────────────────────────────────
function initWindowControls() {
  const windows = document.querySelectorAll(".popup-window")

  windows.forEach((win) => {
    const id = win.id
    const header = win.querySelector(".window-header")
    const btnMin = header.querySelector(".minimize")
    const btnMax = header.querySelector(".maximize")
    const btnCls = header.querySelector(".close")

    if (btnMin) btnMin.addEventListener("click", () => minimizeWindow(id))
    if (btnMax) btnMax.addEventListener("click", () => toggleMaximizeWindow(id))
    if (btnCls) btnCls.addEventListener("click", () => closeWindow(id))

    // Dragging logic
    let isDragging = false,
      offsetX = 0,
      offsetY = 0
    header.addEventListener("mousedown", (e) => {
      if (e.target.tagName === "BUTTON") return
      isDragging = true
      offsetX = e.clientX - win.offsetLeft
      offsetY = e.clientY - win.offsetTop
      win.style.zIndex = getNextZIndex()
      win.classList.add("dragging")
    })

    document.addEventListener(
      "mousemove",
      (e) => {
        if (isDragging && !win.classList.contains("maximized")) {
          win.style.left = `${e.clientX - offsetX}px`
          win.style.top = `${e.clientY - offsetY}px`
        }
      },
      { passive: true }
    )

    document.addEventListener(
      "mouseup",
      () => {
        isDragging = false
        win.classList.remove("dragging")
      },
      { passive: true }
    )

    header.addEventListener("dblclick", (e) => {
      if (e.target.tagName !== "BUTTON") toggleMaximizeWindow(id)
    })

    // Resizing logic
    const directions = ["top", "right", "bottom", "left", "top-left", "top-right", "bottom-left", "bottom-right"]
    directions.forEach((dir) => {
      const resizer = document.createElement("div")
      resizer.classList.add("resizer", `resizer-${dir}`)
      win.appendChild(resizer)

      let isResizing = false
      resizer.addEventListener("mousedown", (e) => {
        if (win.classList.contains("maximized")) return
        e.preventDefault()
        e.stopPropagation()
        isResizing = true
        win.classList.add("resizing")
        const startX = e.clientX
        const startY = e.clientY
        const startWidth = parseInt(getComputedStyle(win).width, 10)
        const startHeight = parseInt(getComputedStyle(win).height, 10)
        const startTop = win.offsetTop
        const startLeft = win.offsetLeft

        function doDrag(e) {
          if (!isResizing) return
          let newWidth = startWidth, newHeight = startHeight, newTop = startTop, newLeft = startLeft
          if (dir.includes("right")) newWidth = Math.max(300, startWidth + e.clientX - startX)
          if (dir.includes("bottom")) newHeight = Math.max(200, startHeight + e.clientY - startY)
          if (dir.includes("left")) {
            const dx = e.clientX - startX
            newWidth = Math.max(300, startWidth - dx)
            newLeft = startLeft + dx
          }
          if (dir.includes("top")) {
            const dy = e.clientY - startY
            newHeight = Math.max(200, startHeight - dy)
            newTop = startTop + dy
          }
          Object.assign(win.style, {
            width: `${newWidth}px`,
            height: `${newHeight}px`,
            top: `${newTop}px`,
            left: `${newLeft}px`
          })
        }

        function stopDrag() {
          isResizing = false
          win.classList.remove("resizing")
          window.removeEventListener("mousemove", doDrag)
          window.removeEventListener("mouseup", stopDrag)
        }

        window.addEventListener("mousemove", doDrag, { passive: true })
        window.addEventListener("mouseup", stopDrag, { passive: true })
      })
    })
  })
}

//────────────────────────────────────────────────────────────────────────────
// 2) WINDOW OPERATIONS & TASKBAR
//────────────────────────────────────────────────────────────────────────────
let currentZIndex = 10
const windowStates = {}
function getNextZIndex() { return ++currentZIndex }

function openWindow(id) {
  const win = document.getElementById(id)
  if (!win) return
  document.getElementById("start-menu").style.display = "none"
  document.querySelectorAll(".popup-window").forEach(w => w.classList.remove("active"))

  win.querySelectorAll("iframe[data-src]").forEach(iframe => {
    if (!iframe.src) iframe.src = iframe.dataset.src
  })
  win.querySelectorAll("video[data-src]").forEach(v => {
    if (!v.src) {
      v.src = v.dataset.src
      v.load()
      if (!isMobile()) v.play().catch(() => {})
    }
  })

  win.classList.remove("hidden")
  win.classList.add("active")
  win.style.display = "flex"
  win.style.zIndex = getNextZIndex()
  win.classList.add("window-opening")
  setTimeout(() => win.classList.remove("window-opening"), 500)

  const isMobileView = isMobile()
  if (isMobileView) {
    Object.assign(win.style, {
      top: "0", left: "0",
      width: "100vw",
      height: "calc(100vh - 36px)",
      transform: "none"
    })
  } else {
    const stored = windowStates[id]
    if (stored) Object.assign(win.style, stored)
    // clamp to viewport...
    const rect = win.getBoundingClientRect(), margin = 20
    const vw = innerWidth, vh = innerHeight
    let [w, h, l, t] = [rect.width, rect.height, rect.left, rect.top]
    if (w > vw - margin*2) w = vw - margin*2
    if (h > vh - margin*2) h = vh - margin*2
    if (l < margin) l = margin
    if (t < margin) t = margin
    if (rect.right > vw - margin) l = vw - margin - w
    if (rect.bottom > vh - margin) t = vh - margin - h
    Object.assign(win.style, { width:`${w}px`, height:`${h}px`, left:`${l}px`, top:`${t}px` })
  }
}

function minimizeWindow(id) {
  const win = document.getElementById(id)
  if (!win) return
  win.classList.add("window-minimizing")
  setTimeout(() => {
    win.classList.remove("window-minimizing")
    win.classList.add("hidden")
    win.style.display = "none"
    createTaskbarIcon(id)
  }, 300)
}

function closeWindow(id) {
  const win = document.getElementById(id)
  if (win) {
    win.classList.add("window-closing")
    setTimeout(() => {
      const vid = win.querySelector("video")
      if (vid) { vid.pause(); vid.currentTime = 0 }
      win.classList.remove("window-closing")
      win.classList.add("hidden")
      win.style.display = "none"
    }, 300)
  }
  const icon = document.getElementById(`taskbar-icon-${id}`)
  if (icon) icon.remove()
}

function createTaskbarIcon(id) {
  if (document.getElementById(`taskbar-icon-${id}`)) return
  const win = document.getElementById(id)
  const title = win ? win.querySelector(".window-header span").textContent.replace(".EXE","") : id
  const btn = document.createElement("button")
  btn.id = `taskbar-icon-${id}`
  btn.className = "taskbar-icon"
  btn.innerHTML = `<span>${title}</span>`
  btn.addEventListener("click", () => { openWindow(id); btn.remove() })
  document.getElementById("taskbar-icons").appendChild(btn)
}

function toggleMaximizeWindow(id) {
  const win = document.getElementById(id)
  if (!win) return
  const isMax = !win.classList.contains("maximized")
  if (isMax) {
    windowStates[id] = {
      parent: win.parentNode,
      next: win.nextSibling,
      position: win.style.position,
      top: win.style.top,
      left: win.style.left,
      width: win.style.width,
      height: win.style.height,
      transform: win.style.transform
    }
    win.classList.add("window-maximizing")
    setTimeout(() => {
      document.body.appendChild(win)
      win.classList.add("maximized")
      win.classList.remove("window-maximizing")
      Object.assign(win.style, {
        position:"fixed", top:"0", left:"0", right:"0", bottom:"36px",
        width:"auto", height:"auto", transform:"none", zIndex:getNextZIndex()
      })
    }, 300)
  } else {
    win.classList.add("window-restoring")
    win.classList.remove("maximized")
    setTimeout(() => {
      const prev = windowStates[id] || {}
      Object.assign(win.style, {
        position: prev.position||"absolute",
        top: prev.top||"", left: prev.left||"",
        width: prev.width||"", height: prev.height||"",
        transform: prev.transform||"", zIndex:getNextZIndex()
      })
      if (prev.parent) prev.parent.insertBefore(win, prev.next)
      win.classList.remove("window-restoring")
    },300)
  }
}

function isMobile() {
  return window.innerWidth < 768
}

//────────────────────────────────────────────────────────────────────────────
// 3) CLOCK & START MENU
//────────────────────────────────────────────────────────────────────────────
function updateClock() {
  const clk = document.getElementById("clock")
  if (!clk) return
  const now = new Date()
  const h = String(now.getHours()).padStart(2,'0')
  const m = String(now.getMinutes()).padStart(2,'0')
  const s = String(now.getSeconds()).padStart(2,'0')
  clk.textContent = `${h}:${m}:${s}`
  clk.classList.add("clock-pulse")
  setTimeout(() => clk.classList.remove("clock-pulse"), 500)
}
setInterval(updateClock,1000)
updateClock()

document.getElementById("start-button").addEventListener("click", () => {
  const m = document.getElementById("start-menu")
  if (m.style.display === "flex") {
    m.classList.add("menu-hiding")
    setTimeout(() => { m.style.display="none"; m.classList.remove("menu-hiding") },300)
  } else {
    m.style.display="flex"
    m.classList.add("menu-showing")
    setTimeout(() => m.classList.remove("menu-showing"),300)
  }
})

//────────────────────────────────────────────────────────────────────────────
// 4) BOOT SEQUENCE
//────────────────────────────────────────────────────────────────────────────
function runBootSequence() {
  return new Promise((resolve) => {
    const bootScreen = document.getElementById("bootScreen")
    const logEl = document.getElementById("boot-log")
    const progress = document.getElementById("progress-bar")
    if (!bootScreen || !logEl || !progress) {
      console.warn("Missing bootScreen elements, skipping boot.")
      resolve()
      return
    }

    const msgs = [
      "[ OK ] Initializing hardware...",
      "[ OK ] Loading kernel modules...",
      "[ OK ] Mounting filesystems...",
      "[ OK ] Starting system services...",
      "[ OK ] Loading neural interface...",
      "[ OK ] Connecting to cyberspace...",
      "[ OK ] CyberDeck v2.0 ready.",
      "[ DONE ] Boot complete."
    ]
    let idx = 0, total = msgs.length, delay = 400

    const typer = setInterval(() => {
      logEl.textContent += msgs[idx] + "\n"
      logEl.scrollTop = logEl.scrollHeight
      progress.style.width = `${((idx+1)/total)*100}%`
      
      idx++
      if (idx === total) {
        clearInterval(typer)
        setTimeout(() => {
          bootScreen.style.transition = "opacity 0.8s"
          bootScreen.style.opacity = "0"
          setTimeout(() => {
            bootScreen.style.display = "none"
            resolve()
          }, 800)
        }, 500)
      }
    }, delay)
  })
}

//────────────────────────────────────────────────────────────────────────────
// 5) DESKTOP ICONS & MULTI-SELECT
//────────────────────────────────────────────────────────────────────────────
function initDesktopIcons() {
  document.querySelectorAll(".desktop-icon").forEach(icon => {
    icon.addEventListener("dblclick", () => openWindow(icon.dataset.window))
    icon.addEventListener("mouseenter", () => icon.classList.add("icon-hover"))
    icon.addEventListener("mouseleave", () => icon.classList.remove("icon-hover"))

    icon.addEventListener("mousedown", e => {
      e.preventDefault()
      const parentRect = icon.parentElement.getBoundingClientRect()
      const clickRect = icon.getBoundingClientRect()
      let group = icon.classList.contains("selected")
        ? Array.from(document.querySelectorAll(".desktop-icon.selected"))
        : (document.querySelectorAll(".desktop-icon.selected").forEach(ic=>ic.classList.remove("selected")), [icon].concat(icon.classList.add("selected")))

      const shiftX = e.clientX - clickRect.left
      const shiftY = e.clientY - clickRect.top

      const groupData = group.map(ic => {
        const r = ic.getBoundingClientRect()
        ic.style.left = `${r.left - parentRect.left}px`
        ic.style.top = `${r.top - parentRect.top}px`
        ic.style.zIndex = getNextZIndex()
        return { icon: ic, startLeft: r.left - parentRect.left, startTop: r.top - parentRect.top }
      })

      function onMouseMove(e) {
        const dx = e.clientX - shiftX - parentRect.left - groupData[0].startLeft
        const dy = e.clientY - shiftY - parentRect.top - groupData[0].startTop
        groupData.forEach(({icon, startLeft, startTop}) => {
          icon.style.left = `${startLeft + dx}px`
          icon.style.top = `${startTop + dy}px`
        })
      }

      document.addEventListener("mousemove", onMouseMove, {passive:true})
      document.addEventListener("mouseup", () => document.removeEventListener("mousemove", onMouseMove), {once:true, passive:true})
    })

    icon.ondragstart = () => false
  })
}

let selStartX, selStartY, selDiv
function onSelectStart(e) {
  if (e.target.closest(".desktop-icon, .popup-window, #start-bar, #start-menu")) return
  selStartX = e.clientX; selStartY = e.clientY
  selDiv = document.createElement("div"); selDiv.id = "selection-rect"
  selDiv.style.left = `${selStartX}px`; selDiv.style.top = `${selStartY}px`
  document.body.appendChild(selDiv)
  document.addEventListener("mousemove", onSelectMove, {passive:true})
  document.addEventListener("mouseup", onSelectEnd, {once:true, passive:true})
  e.preventDefault()
}
function onSelectMove(e) {
  if (!selDiv) return
  const x = Math.min(e.clientX, selStartX),
        y = Math.min(e.clientY, selStartY),
        w = Math.abs(e.clientX - selStartX),
        h = Math.abs(e.clientY - selStartY)
  Object.assign(selDiv.style, { left:`${x}px`, top:`${y}px`, width:`${w}px`, height:`${h}px` })
  const box = selDiv.getBoundingClientRect()
  document.querySelectorAll(".desktop-icon").forEach(icon => {
    const r = icon.getBoundingClientRect()
    icon.classList.toggle("selected", r.left>=box.left && r.right<=box.right && r.top>=box.top && r.bottom<=box.bottom)
  })
}
function onSelectEnd() {
  if (selDiv) selDiv.remove()
  selDiv = null
}
window.addEventListener("mousedown", onSelectStart)

//────────────────────────────────────────────────────────────────────────────
// 6) STARFIELD BACKGROUND
//────────────────────────────────────────────────────────────────────────────
function initStarfield() {
  const canvas = document.getElementById("background-canvas"),
        ctx = canvas.getContext("2d")
  const handleResize = debounce(() => {
    canvas.width = innerWidth; canvas.height = innerHeight; initStars()
  }, 250)
  window.addEventListener("resize", handleResize)
  canvas.width = innerWidth; canvas.height = innerHeight

  const numStars = 300
  const stars = Array.from({length:numStars}, () => ({
    x:Math.random()*canvas.width,
    y:Math.random()*canvas.height,
    z:Math.random()*canvas.width,
    o:Math.random(),
    color:getRandomStarColor()
  }))

  let lastTime = 0
  const fps=120, frameInterval=1000/fps

  function animate(timestamp) {
    if (!lastTime) lastTime=timestamp
    const elapsed = timestamp - lastTime
    if (elapsed>frameInterval) {
      lastTime = timestamp - (elapsed%frameInterval)
      ctx.fillStyle="rgba(0,0,0,0.4)"; ctx.fillRect(0,0,canvas.width,canvas.height)
      const batchSize = Math.min(100, stars.length)
      for (let i=0; i<batchSize; i++){
        const s=stars[i]
        s.z-=2
        if (s.z<=0){
          s.z=canvas.width
          s.x=Math.random()*canvas.width
          s.y=Math.random()*canvas.height
          s.o=Math.random()
          s.color=getRandomStarColor()
        }
        const k=128.0/s.z
        const px=(s.x-canvas.width/2)*k+canvas.width/2
        const py=(s.y-canvas.height/2)*k+canvas.width/2
        const sz=Math.max(0,(1-s.z/canvas.width)*3)
        ctx.globalAlpha=s.o
        ctx.fillStyle=s.color
        ctx.beginPath()
        ctx.arc(px,py,sz,0,Math.PI*2)
        ctx.fill()
      }
      stars.push(...stars.splice(0,batchSize))
    }
    ctx.globalAlpha=1
    requestAnimationFrame(animate)
  }

  function initStars(){
    for(let i=0;i<stars.length;i++){
      stars[i]={x:Math.random()*canvas.width,y:Math.random()*canvas.height,z:Math.random()*canvas.width,o:Math.random(),color:getRandomStarColor()}
    }
  }

  function getRandomStarColor() {
    const colors=["#ffffff","#a9a1ff","#f3a1ff","#00f0ff","#fffc00","#00ff66"]
    return colors[Math.floor(Math.random()*colors.length)]
  }

  requestAnimationFrame(animate)
}

/*───────────────────────────  ─────────────────────────────────────────────────
  GLOBAL VARIABLES & RESET - ULTIMATE CYBERPUNK UPGRADE
─────────────────────────────────────────────────────────────────────────────*/
:root {
  /* Colors */
  --font-press-start: "Press Start 2P", monospace;
  --font-vt323: "VT323", monospace;
  --neon-purple: #a9a1ff;
  --neon-pink: #f3a1ff;
  --neon-cyan: #00f0ff;
  --neon-yellow: #fffc00;
  --neon-green: #00ff66;
  --neon-red: #ff3366;
  --neon-orange: #ff9933;
  --neon-blue: #3366ff;

  /* Typography */
  --font-size-sm: 0.8rem;
  --font-size-base: 1rem;
  --font-size-lg: 1.2rem;
  --font-size-xl: 1.5rem;
  --font-size-2xl: 2rem;
  --font-size-3xl: 2.5rem;

  /* Spacing */
  --spacing-xs: 0.25rem;
  --spacing-sm: 0.5rem;
  --spacing-md: 1rem;
  --spacing-lg: 1.5rem;
  --spacing-xl: 2rem;

  /* Z-index layers */
  --z-background: -1;
  --z-desktop: 1;
  --z-window: 10;
  --z-taskbar: 500;
  --z-startmenu: 600;
  --z-boot: 1000;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  background: black;
  color: white;
  font-family: var(--font-vt323);
  /* allow fixed windows to escape the body bounds */
  overflow: visible !important;
  height: 100vh;
  position: relative;
}

.desktop-icon img {
  filter: drop-shadow(0 0 4px rgba(255, 141, 161, 0.3));
}

/*─────────────────────────────────────────────────────────────────────────────
  SCANLINES OVERLAY
─────────────────────────────────────────────────────────────────────────────*/
.scanlines {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  pointer-events: none;
  background: repeating-linear-gradient(
    to bottom,
    rgba(0, 0, 0, 0) 0px,
    rgba(0, 0, 0, 0.03) 1px,
    rgba(0, 0, 0, 0) 2px
  );
  z-index: 5;
}

/*─────────────────────────────────────────────────────────────────────────────
  GLITCH TITLE
─────────────────────────────────────────────────────────────────────────────*/
.glitch {
  position: relative;
  font-family: var(--font-press-start);
  font-size: var(--font-size-xl);
  color: var(--neon-cyan);
  text-align: center;
  margin-top: var(--spacing-lg);
  user-select: none;
}

.glitch::before,
.glitch::after {
  content: attr(data-text);
  position: absolute;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
  clip-path: inset(0 0 0 0);
}

.glitch::before {
  animation: glitch-top 2s infinite linear;
  color: var(--neon-pink);
}

.glitch::after {
  animation: glitch-bottom 3s infinite linear;
  color: var(--neon-purple);
}

@keyframes glitch-top {
  0% {
    clip-path: inset(0 0 90% 0);
    transform: translate(2px, -2px);
  }
  5% {
    clip-path: inset(0 0 40% 0);
    transform: translate(-2px, 2px);
  }
  10% {
    clip-path: inset(0 0 85% 0);
    transform: translate(2px, 2px);
  }
  15% {
    clip-path: inset(0 0 20% 0);
    transform: translate(-2px, -2px);
  }
  20% {
    clip-path: inset(0 0 90% 0);
    transform: translate(2px, -2px);
  }
  100% {
    clip-path: inset(0 0 0 0);
    transform: translate(0, 0);
  }
}

@keyframes glitch-bottom {
  0% {
    clip-path: inset(85% 0 0 0);
    transform: translate(-2px, 2px);
  }
  10% {
    clip-path: inset(40% 0 0 0);
    transform: translate(2px, -2px);
  }
  20% {
    clip-path: inset(80% 0 0 0);
    transform: translate(-2px, 2px);
  }
  30% {
    clip-path: inset(25% 0 0 0);
    transform: translate(2px, -2px);
  }
  40% {
    clip-path: inset(85% 0 0 0);
    transform: translate(-2px, 2px);
  }
  100% {
    clip-path: inset(0 0 0 0);
    transform: translate(0, 0);
  }
}

/* Glitching animation for elements with .glitching class */
.glitching {
  animation: glitching 0.2s linear;
}

@keyframes glitching {
  0% {
    transform: translate(0);
    filter: hue-rotate(0deg);
  }
  20% {
    transform: translate(-3px, 3px);
    filter: hue-rotate(90deg);
  }
  40% {
    transform: translate(-3px, -3px);
    filter: hue-rotate(180deg);
  }
  60% {
    transform: translate(3px, 3px);
    filter: hue-rotate(270deg);
  }
  80% {
    transform: translate(3px, -3px);
    filter: hue-rotate(360deg);
  }
  100% {
    transform: translate(0);
    filter: hue-rotate(0deg);
  }
}

/* Screen glitch effect */
.screen-glitch {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(255, 255, 255, 0.03);
  mix-blend-mode: overlay;
  pointer-events: none;
  z-index: 9999;
  animation: screen-glitch 0.2s linear;
}

@keyframes screen-glitch {
  0% {
    opacity: 0;
    transform: translateX(0);
  }
  25% {
    opacity: 0.5;
    transform: translateX(5px);
  }
  50% {
    opacity: 0.7;
    transform: translateX(-5px);
  }
  75% {
    opacity: 0.5;
    transform: translateX(5px);
  }
  100% {
    opacity: 0;
    transform: translateX(0);
  }
}

/*─────────────────────────────────────────────────────────────────────────────
  DESKTOP ICONS
─────────────────────────────────────────────────────────────────────────────*/
.container {
  width: 100%;
  height: calc(100vh - 36px); /* leave room for taskbar */
  position: relative;
}

#desktop-icons {
  position: relative;
  width: 100%;
  height: 100%;
}

/* Base icon style */
.desktop-icon {
  position: absolute;
  width: 80px;
  cursor: pointer;
  user-select: none;
  text-align: center;
  transition: transform 0.2s ease, filter 0.2s ease;
}

.desktop-icon img {
  width: 64px;
  height: 64px;
  display: block;
  margin: 0 auto;
  will-change: transform; /* Optimize for animations */
  transition: transform 0.2s ease;
}

.desktop-icon span {
  display: block;
  margin-top: 4px;
  font-size: var(--font-size-sm);
  color: white;
  text-shadow: 0 0 4px rgba(0, 0, 0, 0.7);
}

/* Icon hover effect */
.desktop-icon.icon-hover img {
  transform: scale(1.1);
  filter: drop-shadow(0 0 8px var(--neon-cyan));
}

/* Initial positions */
#icon-about {
  top: 100px;
  left: 40px;
}
#icon-resume {
  top: 100px;
  left: 140px;
}
#icon-contact {
  top: 100px;
  left: 240px;
}
#icon-tigerrr {
  top: 100px;
  left: 340px;
}
#icon-nature {
  top: 200px;
  left: 40px;
}
#icon-Joyful {
  top: 200px;
  left: 140px;
}
#icon-Papaz {
  top: 200px;
  left: 240px;
}
#icon-Abstract {
  top: 200px;
  left: 340px;
}
#icon-music {
  top: 300px;
  left: 40px;
}
#icon-octavia {
  top: 300px;
  left: 140px;
}
#icon-toader {
  top: 300px;
  left: 240px;
}
#icon-MILES {
  top: 300px;
  left: 340px;
}
#icon-SPACEWORM {
  top: 400px;
  left: 40px;
}
#icon-r3d3ch0 {
  top: 400px;
  left: 140px;
}
#icon-tetris {
  top: 400px;
  left: 240px;
}

/* Selected state */
.desktop-icon.selected {
  background: rgba(255, 255, 255, 0.1);
  border: 2px solid var(--neon-cyan);
  border-radius: 4px;
}

/* Multi-select rectangle */
#selection-rect {
  position: absolute;
  border: 2px dashed;
  border-image: linear-gradient(
      45deg,
      var(--neon-pink),
      var(--neon-yellow),
      var(--neon-green),
      var(--neon-cyan),
      var(--neon-purple)
    )
    1;
  background: rgba(255, 255, 255, 0.05);
  pointer-events: none;
  z-index: 999;
}

/*─────────────────────────────────────────────────────────────────────────────
  POPUP WINDOW CHROME
─────────────────────────────────────────────────────────────────────────────*/
.popup-window {
  position: absolute;
  top: 120px;
  left: 120px;
  width: 750px;
  height: 60vh;
  background: rgba(0, 0, 0, 0.9);
  border: 2px solid var(--neon-purple);
  border-radius: 0.5rem;
  box-shadow: 0 0 10px var(--neon-pink);
  display: none;
  flex-direction: column;
  overflow: hidden;
  z-index: var(--z-window);
  will-change: transform, opacity; /* Optimize for animations */
  transition: transform 0.3s ease, opacity 0.3s ease;
}

.popup-window.active {
  display: flex;
  z-index: 100;
}

.popup-window.hidden {
  display: none !important;
}

/* Window animations */
.window-opening {
  animation: window-open 0.3s ease forwards;
}

@keyframes window-open {
  0% {
    transform: scale(0.9);
    opacity: 0;
  }
  100% {
    transform: scale(1);
    opacity: 1;
  }
}

.window-closing {
  animation: window-close 0.3s ease forwards;
}

@keyframes window-close {
  0% {
    transform: scale(1);
    opacity: 1;
  }
  100% {
    transform: scale(0.9);
    opacity: 0;
  }
}

.window-minimizing {
  animation: window-minimize 0.3s ease forwards;
}

@keyframes window-minimize {
  0% {
    transform: scale(1);
    opacity: 1;
  }
  100% {
    transform: scale(0.5) translateY(100vh);
    opacity: 0;
  }
}

.window-maximizing {
  animation: window-maximize 0.3s ease forwards;
}

@keyframes window-maximize {
  0% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.02);
  }
  100% {
    transform: scale(1);
  }
}

.window-restoring {
  animation: window-restore 0.3s ease forwards;
}

@keyframes window-restore {
  0% {
    transform: scale(1);
  }
  50% {
    transform: scale(0.98);
  }
  100% {
    transform: scale(1);
  }
}

/* Header bar */
.popup-window .window-header {
  background: linear-gradient(to right, #111111, #222222);
  color: var(--neon-green);
  font-family: var(--font-press-start);
  font-size: 0.8rem;
  padding: 0.5rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  user-select: none;
  cursor: move;
}

.popup-window .window-header span {
  flex: 1; /* push the buttons to the right */
  text-shadow: 0 0 5px var(--neon-green);
}

.popup-window .window-header button {
  background: none;
  border: none;
  color: var(--neon-green);
  font-family: var(--font-press-start);
  font-size: 1rem;
  cursor: pointer;
  margin-left: 0.5rem;
  transition: color 0.2s ease, text-shadow 0.2s ease;
}

.popup-window .window-header button:hover {
  color: white;
  text-shadow: 0 0 5px var(--neon-green);
}

.popup-window .window-header .minimize:hover {
  color: var(--neon-green);
  text-shadow: 0 0 5px var(--neon-green);
}

.popup-window .window-header .maximize:hover {
  color: var(--neon-green);
  text-shadow: 0 0 5px var(--neon-green);
}

.popup-window .window-header .close:hover {
  color: var(--neon-red);
  text-shadow: 0 0 5px var(--neon-red);
}

/* Content area */
.popup-window .window-content {
  flex: 1;
  padding: 1rem;
  overflow: auto;
  background: rgba(0, 0, 0, 0.8);
}

/* Dragging and resizing states */
.popup-window.dragging {
  opacity: 0.9;
  box-shadow: 0 0 20px var(--neon-purple);
}

.popup-window.resizing {
  opacity: 0.9;
  box-shadow: 0 0 20px var(--neon-cyan);
}

/* Maximized state */
.popup-window.maximized {
  border-radius: 0;
  box-shadow: none;
}

.popup-window.maximized .resizer {
  display: none;
}

/*─────────────────────────────────────────────────────────────────────────────
  BOOT SCREEN
─────────────────────────────────────────────────────────────────────────────*/
.boot-screen {
  position: fixed;
  inset: 0;
  background: black;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: var(--z-boot);
}

.boot-screen .boot-tiger {
  width: 200px;
  margin-bottom: 1rem;
  filter: drop-shadow(0 0 10px var(--neon-purple));
  animation: pulse 2s infinite ease-in-out;
}

@keyframes pulse {
  0%,
  100% {
    transform: scale(1);
    filter: drop-shadow(0 0 10px var(--neon-purple));
  }
  50% {
    transform: scale(1.05);
    filter: drop-shadow(0 0 15px var(--neon-pink));
  }
}

.boot-screen .boot-log {
  width: 100%;
  height: 200px;
  background: black;
  color: var(--neon-green);
  font-family: var(--font-vt323);
  font-size: 0.9rem;
  overflow-y: auto;
  border: 1px solid var(--neon-green);
  margin-bottom: 1rem;
  padding: 0.5rem;
  box-shadow: 0 0 10px rgba(0, 255, 102, 0.3);
}

.boot-screen .progress-container {
  width: 100%;
  background: #333333;
  height: 8px;
  border-radius: 4px;
  overflow: hidden;
}

.boot-screen .progress-bar {
  width: 0;
  height: 100%;
  background: linear-gradient(to right, var(--neon-purple), var(--neon-purple));
  transition: width 1s ease;
  box-shadow: 0 0 10px var(--neon-pink);
}

/*─────────────────────────────────────────────────────────────────────────────
  TASKBAR & START MENU
─────────────────────────────────────────────────────────────────────────────*/
#start-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 36px;
  background: linear-gradient(
    to right,
    rgba(0, 0, 0, 0.9),
    rgba(20, 0, 40, 0.9)
  );
  border-top: 2px solid var(--neon-purple);
  box-shadow: 0 -2px 12px var(--neon-purple);
  display: flex;
  align-items: center;
  padding: 0 1rem;
  font-family: var(--font-press-start);
  z-index: var(--z-taskbar);
}

#taskbar-icons {
  display: flex;
  align-items: center;
  margin-left: 1rem;
  overflow-x: auto;
  max-width: calc(100vw - 200px);
  scrollbar-width: none; /* Firefox */
}

#taskbar-icons::-webkit-scrollbar {
  display: none; /* Chrome, Safari, Edge */
}

.taskbar-icon {
  background: rgba(0, 0, 0, 0.5);
  border: 1px solid var(--neon-cyan);
  border-radius: 4px;
  color: var(--neon-pink);
  margin-right: 0.5rem;
  cursor: pointer;
  font-size: 0.7rem;
  padding: 0.2rem 0.5rem;
  white-space: nowrap;
  transition: all 0.2s ease;
  box-shadow: 0 0 5px rgba(0, 240, 255, 0.3);
}

.taskbar-icon:hover {
  background: rgba(0, 0, 0, 0.7);
  box-shadow: 0 0 10px var(--neon-blue);
}

/* Clock pulse animation */
.clock-pulse {
  animation: clock-pulse 0.5s ease;
}

@keyframes clock-pulse {
  0% {
    color: var(--neon-cyan);
    text-shadow: 0 0 10px var(--neon-cyan);
  }
  100% {
    color: ;
    text-shadow: none;
  }
}

/*─────────────────────────────────────────────────────────────────────────────
  NEON START BAR & BUTTON
─────────────────────────────────────────────────────────────────────────────*/
#start-button {
  font-family: var(--font-press-start);
  font-size: 0.8rem;
  text-transform: uppercase;
  background: transparent;
  border: 2px solid var(--neon-purple);
  border-radius: 4px;
  padding: 0.2rem 0.8rem;
  color: var(--neon-purple);
  box-shadow: 0 0 8px var(--neon-purple);
  cursor: pointer;
  transition: background 0.2s, color 0.2s, box-shadow 0.2s;
}

#start-button:hover {
  background: var(--neon-purple);
  color: black;
  box-shadow: 0 0 12px var(--neon-purple);
}

#clock {
  margin-left: auto;
  font-size: 0.8rem;
  color: white;
  text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
}

/* Start menu */
#start-menu {
  position: fixed;
  bottom: 36px;
  left: 0;
  background: rgba(0, 0, 0, 0.9);
  border: 2px solid var(--neon-purple);
  display: none;
  flex-direction: column;
  font-family: var(--font-press-start);
  z-index: var(--z-startmenu);
  box-shadow: 0 0 15px var(--neon-pink);
  min-width: 200px;
  transition: transform 0.3s ease, opacity 0.3s ease;
}

/* Start menu animations */
.menu-showing {
  animation: menu-show 0.3s ease forwards;
}

@keyframes menu-show {
  0% {
    transform: translateY(20px);
    opacity: 0;
  }
  100% {
    transform: translateY(0);
    opacity: 1;
  }
}

.menu-hiding {
  animation: menu-hide 0.3s ease forwards;
}

@keyframes menu-hide {
  0% {
    transform: translateY(0);
    opacity: 1;
  }
  100% {
    transform: translateY(20px);
    opacity: 0;
  }
}

#start-menu a {
  padding: 0.5rem 1rem;
  color: var(--neon-pink);
  text-decoration: none;
  font-size: 0.8rem;
  transition: background 0.2s, color 0.2s;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

#start-menu a:hover {
  background: rgba(255, 255, 255, 0.1);
  color: var(--neon-cyan);
}

/*─────────────────────────────────────────────────────────────────────────────
  STARFIELD CANVAS
─────────────────────────────────────────────────────────────────────────────*/
#background-canvas {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  z-index: var(--z-background);
}

/* Audio visualizer */
#audio-visualizer {
  position: fixed;
  bottom: 36px;
  left: 0;
  width: 100%;
  height: 100px;
  z-index: 0;
  opacity: 0.5;
  pointer-events: none;
}

/*─────────────────────────────────────────────────────────────────────────────
  MAKE EMBEDDED IFRAMES FILL THEIR POPUP WINDOWS
─────────────────────────────────────────────────────────────────────────────*/
.popup-window {
  /* ensure positioning context */
  position: absolute;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* your existing header stays its normal height… */
.popup-window .window-header {
  flex: 0 0 auto;
}

/* …and the content area fills the rest of the window: */
.popup-window .window-content {
  flex: 1 1 auto; /* grow to fill whatever's left */
  padding: 0; /* remove any default padding */
  overflow: hidden; /* hide scrollbars on the container */
}

/* now the iframe itself also stretches perfectly: */
.popup-window .window-content iframe {
  width: 100%;
  height: 100%;
  border: none;
  display: block; /* avoids weird inline‐iframe gaps */
}

/*─────────────────────────────────────────────────────────────────────────────
   Only override the RESUME & CONTACT embeds
─────────────────────────────────────────────────────────────────────────────*/
#resume .window-content,
#contact .window-content {
  padding: 0; /* remove inner padding so iframe can fill */
}

#resume .window-content iframe,
#contact .window-content iframe {
  width: 100%;
  height: 100%;
  border: none;
  display: block;
}

/*─────────────────────────────────────────────────────────────────────────────
  2) Force the content area (and its iframe) to stretch & scroll if needed
─────────────────────────────────────────────────────────────────────────────*/
.popup-window .window-content {
  display: flex;
  flex-direction: column;
  padding: 0; /* remove any leftover padding */
  height: calc(
    100% - 2.2rem
  ); /* header is ~2.2rem high—adjust if yours differs */
  overflow: hidden;
}

.popup-window .window-content iframe {
  flex: 1;
  width: 100%;
  border: none;
}

/*───────────────────────────────────────────────────────────
  Nature.EXE gallery sizing
────────────────────────────────────────────────────────────*/
#nature .window-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

#nature .window-content img {
  /* never grow beyond its container */
  max-width: 100%;
  max-height: calc(100% - 40px); /* leave room for the buttons below */
  object-fit: contain;
}

/*───────────────────────────────────────────────────────────
  GENERIC GALLERY CONSTRAINTS (Nature + Artwork)
────────────────────────────────────────────────────────────*/
.popup-window .window-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 1rem;
}

.popup-window .window-content img {
  max-width: 100%;
  max-height: calc(100% - 40px); /* leave room for controls */
  object-fit: contain;
}

.gallery-controls {
  margin-top: 0.5rem;
  display: flex;
  justify-content: center;
}

.gallery-controls button {
  margin: 0 0.5rem;
  font-family: var(--font-press-start);
  background: rgba(0, 0, 0, 0.7);
  border: 1px solid var(--neon-cyan);
  padding: 0.5rem 1rem;
  cursor: pointer;
  color: var(--neon-cyan);
  transition: all 0.2s ease;
}

.gallery-controls button:hover {
  background: rgba(0, 0, 0, 0.9);
  box-shadow: 0 0 10px var(--neon-cyan);
}

.toader-comingsoon {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  padding: 2rem;
}

.psychedelic-text {
  font-family: "Press Start 2P", monospace;
  font-size: 1.5rem;
  color: #f3a1ff;
  text-shadow: 0 0 5px #ff00ff, 0 0 10px #00f0ff, 0 0 15px #fffc00,
    0 0 20px #00ff66;
  animation: pulse-glow 1.8s infinite ease-in-out;
  margin-top: 1rem;
}

@keyframes pulse-glow {
  0%,
  100% {
    text-shadow: 0 0 5px #ff00ff, 0 0 10px #00f0ff, 0 0 15px #fffc00,
      0 0 20px #00ff66;
    transform: scale(1);
  }
  50% {
    text-shadow: 0 0 10px #ff00ff, 0 0 20px #00f0ff, 0 0 25px #fffc00,
      0 0 30px #00ff66;
    transform: scale(1.05);
  }
}

.single-art {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 1rem;
}

.single-art img {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
  transition: transform 0.3s ease;
}

.single-art img:hover {
  transform: scale(flex);
}

.popup-window.active video,
.popup-window.active img {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
  display: block;
  margin: auto;
}

.single-art img,
#nature .window-content img {
  transition: opacity 0.5s ease, transform 0.3s ease;
}

/* nature gallery container styling */
#nature .window-content {
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  position: relative;
}

#nature .window-content img {
  position: absolute;
  transition: opacity 0.5s ease, transform 0.3s ease;
}

/* Window resizers */
.resizer {
  position: absolute;
  background: transparent;
  z-index: 10;
}

.resizer-top,
.resizer-bottom {
  height: 4px;
  left: 0;
  right: 0;
  cursor: ns-resize;
}

.resizer-left,
.resizer-right {
  width: 4px;
  top: 0;
  bottom: 0;
  cursor: ew-resize;
}

.resizer-top-left,
.resizer-top-right,
.resizer-bottom-left,
.resizer-bottom-right {
  width: 10px;
  height: 10px;
  background: transparent;
  z-index: 15;
}

.resizer-top-left {
  top: 0;
  left: 0;
  cursor: nwse-resize;
}
.resizer-top-right {
  top: 0;
  right: 0;
  cursor: nesw-resize;
}
.resizer-bottom-left {
  bottom: 0;
  left: 0;
  cursor: nesw-resize;
}
.resizer-bottom-right {
  bottom: 0;
  right: 0;
  cursor: nwse-resize;
}

/* Game windows styling */
.game-window .window-content {
  background: #000;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.game-window canvas {
  background: #000;
  max-width: 100%;
  max-height: 100%;
}

/* Music player styling */
.music-player-interface {
  width: 100%;
  height: 100%;
  background: linear-gradient(to bottom, #000022, #000000);
  display: flex;
  flex-direction: column;
  padding: 1rem;
}

.music-visualizer {
  width: 100%;
  height: 150px;
  background: #000;
  margin-bottom: 1rem;
  border: 1px solid var(--neon-purple);
}

.now-playing {
  text-align: center;
  margin-bottom: 1rem;
  color: var(--neon-cyan);
}

.now-playing-title {
  font-size: 1.2rem;
  font-weight: bold;
  margin-bottom: 0.25rem;
  color: var(--neon-pink);
}

.now-playing-artist {
  font-size: 1rem;
  color: var(--neon-cyan);
}

.player-controls {
  display: flex;
  justify-content: center;
  margin-bottom: 1rem;
}

.player-button {
  background: transparent;
  border: 1px solid var(--neon-purple);
  color: var(--neon-yellow);
  font-size: 1.5rem;
  padding: 0.5rem 1rem;
  margin: 0 0.5rem;
  cursor: pointer;
  transition: all 0.2s ease;
}

.player-button:hover {
  background: rgba(255, 255, 255, 0.1);
  box-shadow: 0 0 10px var(--neon-purple);
}

.progress-container {
  width: 100%;
  height: 5px;
  background: #333;
  margin-bottom: 1rem;
  cursor: pointer;
}

.progress-bar {
  height: 100%;
  background: var(--neon-cyan);
  width: 0;
}

.playlist {
  flex: 1;
  overflow-y: auto;
}

.track-item {
  display: flex;
  align-items: center;
  padding: 0.5rem;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  cursor: pointer;
  transition: background 0.2s ease;
}

.track-item:hover {
  background: rgba(255, 255, 255, 0.1);
}

.track-item.active {
  background: rgba(0, 240, 255, 0.2);
}

.track-number {
  width: 30px;
  color: var(--neon-yellow);
}

.track-info {
  flex: 1;
}

.track-title {
  color: var(--neon-pink);
  margin-bottom: 0.25rem;
}

.track-artist {
  color: var(--neon-cyan);
  font-size: 0.9rem;
}

.track-duration {
  color: var(--neon-green);
}

/* Mobile-friendly improvements */
@media (max-width: 1024px) {
  :root {
    --font-size-xl: 1.8rem;
    --font-size-2xl: 2rem;
    --font-size-3xl: 2.2rem;
  }

  .popup-window {
    width: 90vw;
    height: 80vh;
    top: 10vh;
    left: 5vw;
  }
}

@media (max-width: 768px) {
  :root {
    --font-size-sm: 0.7rem;
    --font-size-base: 0.9rem;
    --font-size-lg: 1.1rem;
    --font-size-xl: 1.5rem;
    --font-size-2xl: 1.8rem;
    --font-size-3xl: 2rem;
  }

  .desktop-icon {
    position: relative;
    display: inline-block;
    width: 25vw;
    margin: 10px;
  }

  #desktop-icons {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    height: auto;
    padding: 1rem 0;
  }

  .popup-window {
    width: 95vw;
    height: 85vh;
    top: 7vh;
    left: 2.5vw;
  }

  #start-menu {
    font-size: 0.7rem;
  }

  #start-bar {
    flex-wrap: wrap;
    height: auto;
    padding: 0.5rem;
  }

  #clock {
    font-size: 0.75rem;
  }

  /* Add mobile-specific close button for easier window management */
  .mobile-close {
    display: block;
    position: fixed;
    bottom: 50px;
    right: 20px;
    background: rgba(0, 0, 0, 0.7);
    color: var(--neon-cyan);
    border: 2px solid var(--neon-cyan);
    border-radius: 50%;
    width: 50px;
    height: 50px;
    font-size: 20px;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
  }
}

@media (max-width: 480px) {
  :root {
    --font-size-sm: 0.6rem;
    --font-size-base: 0.8rem;
    --font-size-lg: 1rem;
    --font-size-xl: 1.2rem;
    --font-size-2xl: 1.5rem;
    --font-size-3xl: 1.8rem;
  }

  .desktop-icon img {
    width: 48px;
    height: 48px;
  }

  .desktop-icon span {
    font-size: 0.6rem;
  }

  .popup-window .window-header {
    font-size: 0.6rem;
    padding: 0.3rem;
  }

  .popup-window .window-header button {
    font-size: 0.8rem;
  }

  .popup-window .window-content {
    padding: 0.5rem;
  }

  #start-menu a {
    padding: 0.3rem 0.6rem;
  }

  #start-button {
    font-size: 0.6rem;
    padding: 0.2rem 0.5rem;
  }

  #clock {
    font-size: 0.6rem;
  }
}

<!-- snake.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>SPACEWORM.EXE</title>

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap"
      rel="stylesheet"
    />

    <!-- Main Stylesheet -->
    <link rel="stylesheet" href="snake.css" />
  </head>
  <body>
    <!-- START OVERLAY -->
    <div id="start-overlay" class="overlay">
      <div class="overlay-content">
        <h1>SPACEWORM.EXE</h1>
        <button id="snake-play-button">CLICK TO START</button>
      </div>
    </div>

    <!-- GAME OVER OVERLAY -->
    <div id="game-over-overlay" class="overlay hidden">
      <div class="overlay-content">
        <h1>Game Over</h1>
        <p id="final-score">Your score: 0</p>
        <div id="score-entry">
          <input
            id="name-input"
            type="text"
            placeholder="Your Name (7 chars)"
            maxlength="7"
          />
          <button id="submit-score">Submit Score</button>
        </div>
        <ol id="high-scores-list"></ol>
        <button id="play-again-button">Play Again</button>
      </div>
    </div>

    <!-- GAME FIELD -->
    <div id="game-field">
      <canvas id="snake-canvas"></canvas>
    </div>

    <!-- HUD -->
    <div id="snake-ui">
      <span id="snake-score">Score: 0</span> |
      <span id="snake-level">Level: 1</span> |
      <span id="snake-best">Best: 0</span> |
      <span id="snake-status">Running</span>
    </div>

    <!-- MUTE BUTTON -->
    <button id="mute-button">🔊</button>

    <!-- JOYSTICK -->
    <div id="joystick">
      <div id="joystick-base">
        <div id="joystick-stick"></div>
      </div>
    </div>

    <!-- MUSIC -->
    <audio
      id="snake-music"
      src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3"
      loop
      preload="auto"
    ></audio>

    <!-- Main Script -->
    <script src="snake.js"></script>
  </body>
</html>

/* snake.css – full stylesheet for SPACEWORM.EXE */

/*─────────────────────────────────────────────────────────────────────────────
  PAGE RESET & BACKGROUND
─────────────────────────────────────────────────────────────────────────────*/
html, body {
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
  background: rgba(0, 0, 0, 0.6); /* translucent black so canvas stars show */
  overflow: hidden;
  font-family: 'Press Start 2P', monospace;
}

/*─────────────────────────────────────────────────────────────────────────────
  OVERLAYS (Start & Game Over)
─────────────────────────────────────────────────────────────────────────────*/
.overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.85);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100;
}
.hidden {
  display: none !important;
}
.overlay-content {
  text-align: center;
  color: white;
}
.overlay-content h1 {
  margin-bottom: 1rem;
  font-size: 2rem;
  color: #00f0ff;
  text-shadow: 0 0 8px #00f0ff;
}
.overlay-content p {
  margin-bottom: 1rem;
  font-size: 1rem;
}
#score-entry {
  margin-bottom: 1rem;
}
#score-entry input {
  font-size: 0.9rem;
  padding: 0.5rem;
  width: 140px;
  text-align: center;
  margin-right: 0.5rem;
}
#score-entry button,
#snake-play-button,
#play-again-button {
  font-size: 0.9rem;
  padding: 0.6rem 1rem;
  border: 2px solid #fffc00;
  background: rgba(0, 0, 0, 0.7);
  color: #fffc00;
  cursor: pointer;
  transition: transform 0.2s, border-color 0.2s;
  text-shadow: 0 0 6px #fffc00;
}
#snake-play-button:hover,
#play-again-button:hover,
#score-entry button:hover {
  transform: scale(1.05);
  border-color: #00f0ff;
}

/*─────────────────────────────────────────────────────────────────────────────
  GAME FIELD & STATIC RAINBOW BORDER
─────────────────────────────────────────────────────────────────────────────*/
#game-field {
  position: absolute;
  top: 60px;    /* leaves room above for HUD */
  bottom: 60px; /* leaves room below for joystick */
  left: 20px;
  right: 20px;
  background: transparent;
  z-index: 1;
}
#game-field::before {
  content: "";
  position: absolute;
  top: -4px; left: -4px; right: -4px; bottom: -4px;
  border: 4px solid transparent;
  border-image: conic-gradient(
    red, orange, yellow, green,
    cyan, blue, magenta, red
  ) 1;
  pointer-events: none;
  z-index: 2;
}

/*─────────────────────────────────────────────────────────────────────────────
  CANVAS (transparent so starfield shows)
─────────────────────────────────────────────────────────────────────────────*/
#snake-canvas {
  width: 100%;
  height: 100%;
  display: block;
  background: transparent !important;
}

/*─────────────────────────────────────────────────────────────────────────────
  HUD (outside the game-field, at top of viewport)
─────────────────────────────────────────────────────────────────────────────*/
#snake-ui {
  position: absolute;
  top: 20px;                /* 20px from top of window */
  left: 50%;
  transform: translateX(-50%);
  z-index: 10;              /* above everything */
  background: rgba(0, 0, 0, 0.4);
  padding: 6px 10px;
  border: 1px solid #00f0ff;
  border-radius: 4px;
  color: white;
  font-size: 0.8rem;
  text-shadow: 0 0 6px #00f0ff;
}
#snake-ui span {
  margin-right: 12px;
}

/*─────────────────────────────────────────────────────────────────────────────
  MUTE BUTTON (top-right of viewport)
─────────────────────────────────────────────────────────────────────────────*/
#mute-button {
  position: absolute;
  top: 20px;
  right: 30px;
  z-index: 10;
  font-size: 1.2rem;
  padding: 4px;
  background: rgba(0, 0, 0, 0.4);
  border: 1px solid #f3a1ff;
  border-radius: 4px;
  color: #f3a1ff;
  cursor: pointer;
  text-shadow: 0 0 6px #f3a1ff;
  transition: transform 0.2s, border-color 0.2s;
}
#mute-button:hover {
  transform: scale(1.1);
  border-color: #00f0ff;
  color: #00f0ff;
}

/*─────────────────────────────────────────────────────────────────────────────
  JOYSTICK (outside the game-field, bottom of viewport)
─────────────────────────────────────────────────────────────────────────────*/
#joystick {
  position: absolute;
  bottom: 20px;             /* 20px from bottom of window */
  left: 50%;
  transform: translateX(-50%);
  z-index: 10;
  touch-action: none;
}
#joystick-base {
  width: 100px;
  height: 100px;
  background: rgba(0, 0, 0, 0.4);
  border: 2px solid #00ff66;
  border-radius: 50%;
  position: relative;
}
#joystick-stick {
  width: 40px;
  height: 40px;
  background: rgba(0, 255, 102, 0.8);
  border-radius: 50%;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  pointer-events: none;
}
#joystick-base.active {
  border-color: #00f0ff;
}

// snake.js – full logic for SPACEWORM.EXE (updated sizing & subtle trails)

window.addEventListener('load', () => {
  // ─── Element refs ─────────────────────────────────────────────────────────
  const startOvl      = document.getElementById('start-overlay');
  const gameOverOvl   = document.getElementById('game-over-overlay');
  const btnPlay       = document.getElementById('snake-play-button');
  const btnSubmit     = document.getElementById('submit-score');
  const inpName       = document.getElementById('name-input');
  const elFinalScore  = document.getElementById('final-score');
  const lstHighScores = document.getElementById('high-scores-list');
  const btnAgain      = document.getElementById('play-again-button');

  const canvas        = document.getElementById('snake-canvas');
  const ctx           = canvas.getContext('2d');
  const ui            = {
    score:  document.getElementById('snake-score'),
    level:  document.getElementById('snake-level'),
    best:   document.getElementById('snake-best'),
    status: document.getElementById('snake-status'),
  };
  const music         = document.getElementById('snake-music');
  const btnMute       = document.getElementById('mute-button');
  const joystickBase  = document.getElementById('joystick-base');
  const joystickStick = document.getElementById('joystick-stick');

  // ─── WebAudio for SFX ───────────────────────────────────────────────────────
  const audioCtx   = new (window.AudioContext||window.webkitAudioContext)();
  let eatBuf, powerBuf;
  const eatURL   = 'https://cdn.glitch.global/09e9ba26-fd4e-41f2-88c1-651c3d32a01a/power-up-type-1-230548.mp3?v=1746542171704';
  const powerURL = 'https://cdn.glitch.global/09e9ba26-fd4e-41f2-88c1-651c3d32a01a/coin-upaif-14631.mp3?v=1746542174524';

  async function loadSound(url) {
    const res = await fetch(url);
    const arr = await res.arrayBuffer();
    return audioCtx.decodeAudioData(arr);
  }
  Promise.all([ loadSound(eatURL), loadSound(powerURL) ])
         .then(([e,p])=>{ eatBuf=e; powerBuf=p; });

  function playSFX(buf) {
    if (!buf) return;
    const src = audioCtx.createBufferSource();
    src.buffer = buf;
    src.connect(audioCtx.destination);
    src.start();
  }

  // ─── Pause music when tab hidden ───────────────────────────────────────────
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      music.pause();
      music.currentTime = 0;
    }
  });

  // ─── Starfield ──────────────────────────────────────────────────────────────
  let stars = [];
  const STAR_COUNT = 175;
  function initStars() {
    stars = Array.from({ length: STAR_COUNT }, () => ({
      x: Math.random()*canvas.width,
      y: Math.random()*canvas.height,
      z: Math.random()*canvas.width,
      o: Math.random()
    }));
  }
  function drawStars() {
    // slight motion-blur
    ctx.fillStyle = 'rgba(0,0,0,1)';
    ctx.fillRect(0,0,canvas.width,canvas.height);

    for (let s of stars) {
      // twinkle
      s.o += (Math.random()-0.5)*0.02;
      s.o = Math.max(0.1, Math.min(1, s.o));

      s.z -= 2;
      if (s.z <= 0) {
        s.z = canvas.width;
        s.x = Math.random()*canvas.width;
        s.y = Math.random()*canvas.height;
        s.o = Math.random();
      }
      const k  = 128.0/s.z;
      const px = (s.x - canvas.width/2)*k + canvas.width/2;
      const py = (s.y - canvas.height/2)*k + canvas.height/2;
      const sz = Math.max(0.5, (1 - s.z/canvas.width)*2);  // HALF as big as before

      ctx.globalAlpha = s.o;
      ctx.fillStyle   = '#fff';
      ctx.beginPath();
      ctx.arc(px,py,sz,0,Math.PI*2);
      ctx.fill();
    }
    ctx.globalAlpha = 1;
  }

  // ─── Game state ─────────────────────────────────────────────────────────────
  const GRID = 17.5;
  let cols, rows;
  let snake, dx, dy, apple;
  let baseSpeed, speed, score, level, best;
  let paused, gameOver, started, hueOffset;
  let powerUps, particles, trail;
  let frameAcc = 0, lastTime = 0;

  const HS_KEY = 'snakeHighScores';
  const MAX_HS = 7;
  const POWER_DEF = {
    SPEED:      { color:'cyan',    effect:'speed',      duration:5000, value:2,  pts:5  },
    GROW:       { color:'magenta', effect:'grow',       duration:3000, value:3,  pts:8  },
    INVINCIBLE: { color:'yellow',  effect:'invincible', duration:5000, value:0,  pts:10 }
  };
  const MAX_TRAIL = .5;  

  // ─── High-score helpers ────────────────────────────────────────────────────
  function loadHS() {
    const j = localStorage.getItem(HS_KEY);
    return j ? JSON.parse(j) : [];
  }
  function saveHS(list) {
    localStorage.setItem(HS_KEY, JSON.stringify(list));
  }
  function drawHS() {
    lstHighScores.innerHTML = loadHS()
      .map(h => `<li>${h.name}: ${h.score}</li>`)
      .join('');
  }
  function addHS(name,val) {
    const l = loadHS();
    l.push({ name, score: val });
    l.sort((a,b)=>b.score-a.score);
    saveHS(l.slice(0,MAX_HS));
  }

  // ─── Game helpers ──────────────────────────────────────────────────────────
  function placeApple(){
    do {
      apple = {
        x: Math.floor(Math.random()*cols),
        y: Math.floor(Math.random()*rows)
      };
    } while (
      snake.some(s=>s.x===apple.x&&s.y===apple.y) ||
      powerUps.some(p=>p.x===apple.x&&p.y===apple.y)
    );
  }
  function createPU(){
    const types = Object.keys(POWER_DEF);
    const t     = types[Math.floor(Math.random()*types.length)];
    const d     = POWER_DEF[t];
    powerUps.push({
      x: Math.floor(Math.random()*cols),
      y: Math.floor(Math.random()*rows),
      type: t,
      color: d.color,
      duration: d.duration,
      start: Date.now()
    });
  }
  function createParticle(x,y,color){
    particles.push({
      x: x*GRID + GRID/2,
      y: y*GRID + GRID/2,
      size: Math.random()*3 + 1,  // smaller
      vx: (Math.random()-0.5)*2,
      vy: (Math.random()-0.5)*2,
      color,
      alpha: 1
    });
  }
  function updateParticles(){
    for(let i=particles.length-1;i>=0;i--){
      const p = particles[i];
      p.x+=p.vx; p.y+=p.vy; p.alpha-=0.02;
      if(p.alpha<=0) particles.splice(i,1);
    }
  }
  function applyPU(pu){
    const d = POWER_DEF[pu.type];
    // award points
    score += d.pts;
    ui.score.textContent = `Score: ${score}`;
    if(score > best){
      best = score;
      ui.best.textContent = `Best: ${best}`;
    }
    switch(d.effect){
      case 'speed':
        speed = baseSpeed*1.5;
        createParticle(snake[0].x, snake[0].y, d.color);
        break;
      case 'grow':
        for(let i=0;i<d.value;i++){
          const tail = snake[snake.length-1];
          snake.push({ x: tail.x, y: tail.y });
        }
        createParticle(snake[0].x, snake[0].y, d.color);
        break;
      case 'invincible':
        snake.invincible = true;
        setTimeout(()=>snake.invincible = false, d.duration);
        createParticle(snake[0].x, snake[0].y, d.color);
        break;
    }
  }

  // ─── Update & draw ─────────────────────────────────────────────────────────
  function update(dt){
    if(!started||paused||gameOver) return;
    frameAcc += dt;
    if(frameAcc < 1000/speed) return;
    frameAcc = 0;

    powerUps = powerUps.filter(pu => Date.now() - pu.start < pu.duration);
    if(Math.random() < 0.01) createPU();

    const head = { x: snake[0].x + dx, y: snake[0].y + dy };
    snake.unshift(head);

    trail.unshift({ x: head.x, y: head.y, t: Date.now() });
    if(trail.length > MAX_TRAIL) trail.pop();

    powerUps.forEach((pu,i)=>{
      if(head.x===pu.x&&head.y===pu.y){
        playSFX(powerBuf);
        applyPU(pu);
        powerUps.splice(i,1);
      }
    });

    if(head.x===apple.x&&head.y===apple.y){
      playSFX(eatBuf);
      score += 10;
      ui.score.textContent = `Score: ${score}`;
      if(score > best){
        best = score;
        ui.best.textContent = `Best: ${best}`;
      }
      for(let i=0;i<8;i++) createParticle(apple.x, apple.y, 'magenta');
      if(score % 50 === 0){
        level++;
        ui.level.textContent = `Level: ${level}`;
        for(let i=0;i<8;i++) createParticle(head.x, head.y, 'cyan');
      }
      placeApple();
    } else {
      snake.pop();
    }

    if(!snake.invincible){
      if(head.x<0||head.y<0||head.x>=cols||head.y>=rows||
         snake.slice(1).some(s=>s.x===head.x&&s.y===head.y)){
        gameOver = true;
        ui.status.textContent = 'Game Over';
        elFinalScore.textContent = `Your score: ${score}`;
        gameOverOvl.classList.remove('hidden');
        music.pause(); music.currentTime=0;
        for(let i=0;i<20;i++) createParticle(head.x, head.y, 'red');
      }
    }
  }

  function draw(){
    if(!started) return;
    drawStars();

    // trails (more subtle)
    const S = GRID-2, O = 1;
    trail.forEach((pt, idx)=>{
      const age = Date.now() - pt.t;
      const a   = Math.max(0,1 - age/1000)*0.2;  // half the intensity
      ctx.fillStyle = `hsla(${(hueOffset+idx*20)%360},100%,50%,${a})`;
      ctx.fillRect(pt.x*GRID+O, pt.y*GRID+O, S, S);
    });

    // power-ups
    powerUps.forEach(pu=>{
      ctx.fillStyle = pu.color;
      ctx.fillRect(pu.x*GRID+1, pu.y*GRID+1, GRID-2, GRID-2);
      ctx.fillStyle = 'black';
      ctx.font = '10px Press Start 2P';
      ctx.fillText(pu.type[0], pu.x*GRID+3, pu.y*GRID+14);
    });

    // apple (smaller)
    const pulse = Math.sin(Date.now()/300)*6;
    ctx.fillStyle = `hsl(300,100%,${50+pulse}%)`;
    ctx.fillRect(apple.x*GRID+3, apple.y*GRID+3, GRID-6, GRID-6);

    // snake (smaller)
    snake.forEach((seg,i)=>{
      const hue = (hueOffset + i*10 + level*20)%360;
      ctx.fillStyle = `hsl(${hue},100%,50%)`;
      ctx.fillRect(seg.x*GRID+3, seg.y*GRID+3, GRID-6, GRID-6);
    });

    // particles
    particles.forEach(p=>{
      ctx.globalAlpha = p.alpha;
      ctx.fillStyle   = p.color;
      ctx.beginPath();
      ctx.arc(p.x,p.y,p.size,0,2*Math.PI);
      ctx.fill();
    });
    ctx.globalAlpha = 1;

    hueOffset = (hueOffset + 1 + level)%360;
  }

  function loop(ts){
    if(!lastTime) lastTime = ts;
    const dt = ts - lastTime;
    lastTime = ts;
    update(dt);
    draw();
    updateParticles();
    requestAnimationFrame(loop);
  }

  // ─── Controls/UI ───────────────────────────────────────────────────────────
  function resetGame(){
    music.pause(); music.currentTime=0;
    cols = Math.floor(canvas.width/GRID);
    rows = Math.floor(canvas.height/GRID);
    snake = [{ x: Math.floor(cols/2), y: Math.floor(rows/2) }];
    dx=1; dy=0;
    baseSpeed=5; speed=baseSpeed;
    score=0; level=1;
    paused=false; gameOver=false; started=false;
    hueOffset=0;
    powerUps=[]; particles=[]; trail=[];
    ui.score.textContent='Score: 0';
    ui.level.textContent='Level: 1';
    best = (loadHS()[0]||{score:0}).score;
    ui.best.textContent=`Best: ${best}`;
    ui.status.textContent='Running';
    startOvl.classList.remove('hidden');
    gameOverOvl.classList.add('hidden');
    drawHS();
    placeApple();
  }

  btnPlay.addEventListener('click', ()=>{
    audioCtx.resume();
    started=true;
    startOvl.classList.add('hidden');
    music.play().catch(()=>{});
    requestAnimationFrame(loop);
  });

  btnSubmit.addEventListener('click', ()=>{
    const n = inpName.value.trim()||'ANON';
    addHS(n,score); drawHS();
    btnSubmit.disabled=true; inpName.disabled=true;
  });

  btnAgain.addEventListener('click', ()=>{
    resetGame();
    btnSubmit.disabled=false; inpName.disabled=false; inpName.value='';
    music.pause(); music.currentTime=0;
    btnPlay.click();
  });

  // keyboard
  window.addEventListener('keydown', e=>{
    if(!started) return;
    if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight',' '].includes(e.key)) e.preventDefault();
    if(e.key===' '){
      paused = !paused;
      ui.status.textContent = paused?'Paused':'Running';
      paused ? music.pause() : music.play().catch(()=>{});
      return;
    }
    if(paused||gameOver) return;
    switch(e.key){
      case 'ArrowUp':    if(dy===0){dx=0;dy=-1;} break;
      case 'ArrowDown':  if(dy===0){dx=0;dy=1;}  break;
      case 'ArrowLeft':  if(dx===0){dx=-1;dy=0;} break;
      case 'ArrowRight': if(dx===0){dx=1;dy=0;}  break;
    }
    if(e.key.startsWith('Arrow')) speed = baseSpeed*2;
  });
  window.addEventListener('keyup', e=>{
    if(e.key.startsWith('Arrow')) speed = baseSpeed;
  });

  // joystick
  let joyId=null, joyR=50;
  joystickBase.addEventListener('touchstart', e=>{
    e.preventDefault();
    const t = e.changedTouches[0];
    joyId = t.identifier;
    joystickBase.classList.add('active');
  });
  joystickBase.addEventListener('touchmove', e=>{
    e.preventDefault();
    for(const t of e.changedTouches){
      if(t.identifier!==joyId) continue;
      const r = joystickBase.getBoundingClientRect();
      const cx = r.left + r.width/2, cy = r.top + r.height/2;
      let dxT = t.clientX - cx, dyT = t.clientY - cy;
      const d = Math.hypot(dxT,dyT);
      if(d>joyR){ dxT = dxT/d*joyR; dyT = dyT/d*joyR; }
      joystickStick.style.transform = `translate(${dxT}px,${dyT}px)`;
      if(d>joyR*0.3){
        if(Math.abs(dxT)>Math.abs(dyT)){ dx = dxT>0?1:-1; dy=0; }
        else { dx=0; dy=dyT>0?1:-1; }
      }
      speed = baseSpeed*2;
      break;
    }
  });
  joystickBase.addEventListener('touchend', e=>{
    for(const t of e.changedTouches){
      if(t.identifier!==joyId) continue;
      joyId = null;
      joystickBase.classList.remove('active');
      joystickStick.style.transform = 'translate(-50%,-50%)';
      speed = baseSpeed;
      break;
    }
  });

  // mute
  btnMute.addEventListener('click', ()=>{
    music.muted = !music.muted;
    btnMute.textContent = music.muted?'🔇':'🔊';
  });

  // init
  canvas.width  = canvas.clientWidth;
  canvas.height = canvas.clientHeight;
  initStars();
  resetGame();
});

